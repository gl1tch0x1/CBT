{% extends 'base.html' %}

{% block title %}Taking {{ exam.title }} - CBT System by NAME IT Education{% endblock %}

{% block extra_css %}
<style>
.timer-display {
    font-size: 1.5rem;
    font-weight: bold;
}
.question-card {
    border-left: 4px solid #007bff;
}
.choice-option {
    cursor: pointer;
    transition: background-color 0.2s;
}
.choice-option:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ exam.title }}</strong> - {{ exam.subject.name }}
                    <br><small>Duration: {{ exam.duration }} minutes | Questions: {{ exam.questions.count }}</small>
                </div>
                <div class="timer-display text-danger" id="timer">
                    <i class="fas fa-clock me-1"></i>
                    <span id="time-remaining">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="exam-form">
        {% csrf_token %}

        <div class="row">
            <div class="col-md-9">
                {% for question in exam.questions.all %}
                    <div class="card question-card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-question-circle me-2"></i>
                                Question {{ forloop.counter }} of {{ exam.questions.count }}
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="card-text mb-4">{{ question.question|linebreaks }}</p>

                            <div class="row">
                                {% for choice in question.choice_set.all %}
                                    <div class="col-md-6 mb-3">
                                        <div class="choice-option p-3 border rounded">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio"
                                                       name="{{ question.id }}"
                                                       value="{{ choice.id }}"
                                                       id="choice_{{ choice.id }}">
                                                <label class="form-check-label w-100" for="choice_{{ choice.id }}">
                                                    {{ choice.body }}
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="col-md-3">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-2"></i>Question Navigator
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            {% for question in exam.questions.all %}
                                <div class="col-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 question-nav"
                                            data-question="{{ forloop.counter }}">
                                        {{ forloop.counter }}
                                    </button>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success" id="submit-exam">
                                <i class="fas fa-paper-plane me-1"></i>Submit Exam
                            </button>
                            <button type="button" class="btn btn-warning" id="save-draft" disabled>
                                <i class="fas fa-save me-1"></i>Save Draft
                            </button>
                        </div>

                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Your answers are automatically saved. You can navigate between questions freely.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Auto-submit Modal -->
<div class="modal fade" id="autoSubmitModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Time's Up!
                </h5>
            </div>
            <div class="modal-body">
                <p>The exam time has expired. Your answers will be automatically submitted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirm-auto-submit">
                    <i class="fas fa-check me-1"></i>OK
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Timer functionality
    const expiryTime = new Date("{{ expiry_time|date:'c' }}");

    function updateTimer() {
        const now = new Date();
        const timeLeft = expiryTime - now;

        if (timeLeft <= 0) {
            // Time's up - auto submit
            $('#autoSubmitModal').modal('show');
            $('#confirm-auto-submit').click(function() {
                $('#exam-form').submit();
            });
            return;
        }

        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        $('#time-remaining').text(timeString);

        // Change color when time is running low
        if (timeLeft < 5 * 60 * 1000) { // Less than 5 minutes
            $('#timer').removeClass('text-danger').addClass('text-danger');
            if (timeLeft < 60 * 1000) { // Less than 1 minute
                $('#timer').addClass('blink');
            }
        }
    }

    // Update timer every second
    updateTimer();
    const timerInterval = setInterval(updateTimer, 1000);

    // Question navigation
    $('.question-nav').click(function() {
        const questionNum = $(this).data('question');
        const targetCard = $('.question-card').eq(questionNum - 1);
        $('html, body').animate({
            scrollTop: targetCard.offset().top - 100
        }, 500);
    });

    // Update question navigator based on answered questions
    $('input[type="radio"]').change(function() {
        const questionId = $(this).attr('name');
        const questionIndex = $('.question-card').index($(this).closest('.question-card'));
        const navButton = $('.question-nav').eq(questionIndex);

        navButton.removeClass('btn-outline-secondary').addClass('btn-success');
    });

    // Confirm before leaving page
    window.addEventListener('beforeunload', function(e) {
        e.preventDefault();
        e.returnValue = '';
    });

    // Remove confirmation when submitting
    $('#exam-form').submit(function() {
        window.removeEventListener('beforeunload', function() {});
        clearInterval(timerInterval);
    });

    // Submit confirmation
    $('#submit-exam').click(function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to submit your exam? You cannot change your answers after submission.')) {
            $('#exam-form').submit();
        }
    });
});
</script>

<style>
/* Blinking animation for urgent timer */
.blink {
    animation: blink-animation 1s steps(5, start) infinite;
}

@keyframes blink-animation {
    to {
        visibility: hidden;
    }
}
</style>
{% endblock %}
