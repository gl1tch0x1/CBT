{% extends 'base.html' %}
{% load static %}

{% block title %}Taking {{ exam.title }} - CBT System by NAME IT Education{% endblock %}

{% block extra_css %}
<style>
.timer-display {
    font-size: 1.5rem;
    font-weight: bold;
}
.question-card {
    border-left: 4px solid #007bff;
}
.choice-option {
    cursor: pointer;
    transition: background-color 0.2s;
}
.choice-option:hover {
    background-color: #f8f9fa;
}

/* Anti-cheating styles */
.anti-cheat-warning {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #dc3545;
    color: white;
    padding: 10px;
    text-align: center;
    z-index: 9999;
    font-weight: bold;
    display: none;
}

.exam-container {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

/* Disable text selection except for inputs */
.exam-container * {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.exam-container input[type="radio"],
.exam-container input[type="checkbox"],
.exam-container textarea {
    user-select: auto;
    -webkit-user-select: auto;
    -moz-user-select: auto;
    -ms-user-select: auto;
}

/* Fullscreen styles */
.fullscreen-notice {
    background: #28a745;
    color: white;
    padding: 5px 10px;
    font-size: 0.9rem;
    border-radius: 4px;
    margin-bottom: 10px;
}

/* Blinking animation for urgent timer */
.blink {
    animation: blink-animation 1s steps(5, start) infinite;
}

@keyframes blink-animation {
    to {
        visibility: hidden;
    }
}
</style>
{% endblock %}

{% block content %}
<!-- Anti-cheating warning banner -->
<div class="anti-cheat-warning" id="anti-cheat-warning">
    <i class="fas fa-exclamation-triangle me-2"></i>
    ANTI-CHEATING MONITORING ACTIVE - Any suspicious activity will terminate your exam
</div>

<div class="container-fluid exam-container" id="exam-content">
    <!-- Fullscreen notice -->
    <div class="fullscreen-notice text-center" id="fullscreen-notice">
        <i class="fas fa-expand me-2"></i>Exam is running in secure fullscreen mode
    </div>

    <div class="row">
        <div class="col-12">
            <div class="alert alert-info d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ exam.title }}</strong> - {{ exam.subject.name }}
                    <br><small>Duration: {{ exam.duration }} minutes | Questions: {{ exam.questions.count }}</small>
                    <br><small class="text-warning">
                        <i class="fas fa-shield-alt me-1"></i>
                        Anti-cheating monitoring is active. Do not switch tabs, open developer tools, or leave this window.
                    </small>
                </div>
                <div class="timer-display text-danger" id="timer">
                    <i class="fas fa-clock me-1"></i>
                    <span id="time-remaining">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="exam-form">
        {% csrf_token %}

        <div class="row">
            <div class="col-md-9">
                {% for question in exam.questions.all %}
                    <div class="card question-card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-question-circle me-2"></i>
                                Question {{ forloop.counter }} of {{ exam.questions.count }}
                            </h6>
                        </div>
                        <div class="card-body">
                            <p class="card-text mb-4">{{ question.question|linebreaks }}</p>

                            <div class="row">
                                {% for choice in question.choice_set.all %}
                                    <div class="col-md-6 mb-3">
                                        <div class="choice-option p-3 border rounded">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio"
                                                       name="{{ question.id }}"
                                                       value="{{ choice.id }}"
                                                       id="choice_{{ choice.id }}">
                                                <label class="form-check-label w-100" for="choice_{{ choice.id }}">
                                                    {{ choice.body }}
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="col-md-3">
                <div class="card sticky-top" style="top: 20px;">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-2"></i>Question Navigator
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2 mb-3">
                            {% for question in exam.questions.all %}
                                <div class="col-3">
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100 question-nav"
                                            data-question="{{ forloop.counter }}">
                                        {{ forloop.counter }}
                                    </button>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success" id="submit-exam" name="submit_exam" value="true">
                                <i class="fas fa-paper-plane me-1"></i>Submit Exam
                            </button>
                            <button type="button" class="btn btn-warning" id="save-draft" disabled>
                                <i class="fas fa-save me-1"></i>Save Draft
                            </button>
                        </div>

                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Your answers are automatically saved. You can navigate between questions freely.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Auto-submit Modal -->
<div class="modal fade" id="autoSubmitModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>Time's Up!
                </h5>
            </div>
            <div class="modal-body">
                <p>The exam time has expired. Your answers will be automatically submitted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirm-auto-submit">
                    <i class="fas fa-check me-1"></i>OK
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Load anti-cheating JavaScript -->
<script src="{% load static %}{% static 'js/anti-cheating.js' %}"></script>

<script>
$(document).ready(function() {
    // Initialize anti-cheating monitor
    const antiCheatMonitor = new AntiCheatMonitor({
        csrfToken: '{{ csrf_token }}',
        examId: '{{ exam.id }}',
        onTerminate: function(reason, violations) {
            // Custom termination handler
            console.error('Exam terminated:', reason);

            // Hide exam content
            $('#exam-content').hide();

            // Show termination message
            const terminationHtml = `
                <div class="container mt-5">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="alert alert-danger text-center" style="padding: 40px; border: 3px solid #dc3545;">
                                <i class="fas fa-exclamation-triangle fa-4x mb-4 text-danger"></i>
                                <h2 class="text-danger mb-3">EXAM TERMINATED</h2>
                                <p class="lead mb-3">The exam is terminated due to suspicious cheating activity.</p>
                                <p><strong>Reason:</strong> ${reason}</p>
                                <p class="mt-4">Please contact your instructor if you believe this is an error.</p>
                                <div class="mt-4">
                                    <button class="btn btn-secondary" onclick="window.location.href='/exam/myexams/'">
                                        <i class="fas fa-arrow-left me-2"></i>Return to My Exams
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            $('body').html(terminationHtml);

            // Submit termination to server
            $.post(window.location.href, {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
                'terminate_exam': 'true',
                'termination_reason': reason
            });
        }
    });


    // Timer functionality with fallback for missing/invalid expiry_time
    const expiryTimeStr = "{{ expiry_time|date:'c' }}";
    const expiryTime = expiryTimeStr ? new Date(expiryTimeStr) : null;

    function updateTimer() {
        if (!expiryTime || isNaN(expiryTime.getTime())) {
            $('#time-remaining').text('Timer unavailable');
            return;
        }
        const now = new Date();
        const timeLeft = expiryTime - now;

        if (timeLeft <= 0) {
            // Stop anti-cheat monitoring before auto-submit
            antiCheatMonitor.stopMonitoring();

            // Time's up - auto submit
            $('#autoSubmitModal').modal('show');
            $('#confirm-auto-submit').click(function() {
                $('#exam-form').submit();
            });
            return;
        }

        const hours = Math.floor(timeLeft / (1000 * 60 * 60));
        const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

        const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        $('#time-remaining').text(timeString);

        // Change color when time is running low
        if (timeLeft < 5 * 60 * 1000) { // Less than 5 minutes
            $('#timer').removeClass('text-danger').addClass('text-danger');
            if (timeLeft < 60 * 1000) { // Less than 1 minute
                $('#timer').addClass('blink');
            }
        }
    }

    // Update timer every second
    updateTimer();
    const timerInterval = setInterval(updateTimer, 1000);

    // Question navigation
    $('.question-nav').click(function() {
        const questionNum = $(this).data('question');
        const targetCard = $('.question-card').eq(questionNum - 1);
        $('html, body').animate({
            scrollTop: targetCard.offset().top - 100
        }, 500);
    });

    // Update question navigator based on answered questions
    $('input[type="radio"]').change(function() {
        const questionId = $(this).attr('name');
        const questionIndex = $('.question-card').index($(this).closest('.question-card'));
        const navButton = $('.question-nav').eq(questionIndex);

        navButton.removeClass('btn-outline-secondary').addClass('btn-success');
    });

    // Enhanced beforeunload handling
    window.addEventListener('beforeunload', function(e) {
        if (antiCheatMonitor.isActive) {
            e.preventDefault();
            e.returnValue = 'Are you sure you want to leave? Your exam will be terminated.';
            return e.returnValue;
        }
    });

    // Remove confirmation and stop monitoring when submitting
    $('#exam-form').submit(function() {
        antiCheatMonitor.stopMonitoring();
        window.removeEventListener('beforeunload', function() {});
        clearInterval(timerInterval);
    });

    // Submit confirmation
    $('#submit-exam').click(function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to submit your exam? You cannot change your answers after submission.')) {
            antiCheatMonitor.stopMonitoring();
            $('#exam-form').submit();
        }
    });

    // Show anti-cheat warning briefly
    $('#anti-cheat-warning').fadeIn(500).delay(3000).fadeOut(500);

    // Disable right-click and text selection (additional layer)
    $(document).on('contextmenu', function(e) {
        e.preventDefault();
        return false;
    });

    // Disable F12 and other dev tools shortcuts (additional layer)
    $(document).keydown(function(e) {
        if (e.keyCode === 123 || // F12
            (e.ctrlKey && e.shiftKey && e.keyCode === 73) || // Ctrl+Shift+I
            (e.ctrlKey && e.shiftKey && e.keyCode === 74) || // Ctrl+Shift+J
            (e.ctrlKey && e.keyCode === 85)) { // Ctrl+U
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}
